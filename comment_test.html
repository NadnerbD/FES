<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<link rel="stylesheet" type="text/css" href="comments.css" />
	<script type="text/javascript">
		var test_users = {
			0: {
				name: "Nadnerb",
				avatar: "http://www.fimfiction-static.net/images/avatars/91255_128.jpg?1361969153"
			}
		};
	</script>
	<script type="text/javascript">
		// fetch emoticon list
		function fetchEmotes(callback) {
			var request = new XMLHttpRequest();
			request.onreadystatechange = function() {
				if(request.readyState == 4) {
					var emoteObject = {};
					var emoteList = JSON.parse(request.response);
					for(var i in emoteList) {
						emoteObject[emoteList[i][0]] = "emotes/" + emoteList[i][0] + ".png";
					}
					parser.registerEmotes(emoteObject);
					emotesFetched = true;
					callback();
				}
			};
			request.open("GET", "emotes/emoticons.json", true);
			request.send(null);
		}
	</script>
	<script type="text/javascript">
		// fetch the comment data
		function fetchComments(callback) {
			var request = new XMLHttpRequest();
			request.onreadystatechange = function() {
				if(request.readyState == 4) {
					comments = JSON.parse(request.response);
					commentsFetched = true;
					callback();
				}
			};
			request.open("GET", "comments.json", true);
			request.send(null);
		}
	</script>
	<script type="text/javascript">
		// fetch the story list
		function fetchStories(callback) {
			var request = new XMLHttpRequest();
			request.onreadystatechange = function() {
				if(request.readyState == 4) {
					storyList = JSON.parse(request.response);
					stories = new Object();
					for(var i in storyList) {
						stories["story/" + storyList[i].id] = storyList[i];
					}
					storiesFetched = true;
					callback();
				}
			};
			request.open("GET", "tracking.json", true);
			request.send(null);
		}
	</script>
	<script type="text/javascript" src="bbcode.js"></script>
	<link rel="stylesheet" type="text/css" href="bbcode.css" />
	<script type="text/javascript">
		var parser = new bbcode();
		var commentsFetched = false;
		var emotesFetched = false;
		var storiesFetched = false;
		function init() {
			fetchEmotes(init2);
			fetchComments(init2);
			fetchStories(init2);
		}
		function init2() {
			if(!(commentsFetched && emotesFetched && storiesFetched)) return;
			writeComments();
			document.addEventListener("click", handleClick);
			window.onhashchange = highlightSelected;
			highlightSelected();
		}
		function handleClick(event) {
			// the most hilarious hack I ever did, literally copies elements from the page into the space where the quote goes
			if(event.target.classList.contains("quote_link")) {
				if(event.target.nextSibling.nodeName == "DIV") {
					event.target.parentNode.removeChild(event.target.nextSibling);
				}else{
					var elem = document.getElementsByName(event.target.hash.substring(1));
					if(elem.length) {
						var quote_container = document.createElement("div");
						quote_container.appendChild(elem[0].parentNode.cloneNode(true));
						event.target.parentNode.insertBefore(quote_container, event.target.nextSibling);
					}
				}
				event.preventDefault();
			}
		}
		function highlightSelected() {
			var elem = document.getElementsByClassName("selected");
			for(var i = 0; i < elem.length; i++) {
				elem[i].classList.remove("selected");
			}
			var jump = document.getElementsByName(window.location.hash.substring(1));
			for(var i = 0; i < jump.length; i++) {
				jump[i].parentNode.classList.add("selected");
			}
		}
		function writeComments() {
			// feed all the comments into a fragment so we can add them simultaneously
			var frag = document.createDocumentFragment();
			for(var story in comments) {
				var storyComments = comments[story];
				if(storyComments.length == 0) continue;
				var header = {tag: "div", attrs: {className: "story_comments"}, children: [
					{tag: "h2", children: [stories[story].title + " (" + storyComments.length + ")"]}
				]};
				var container = createTree(header);
				for(var i in storyComments) {
					var comment = storyComments[i];
					container.appendChild(createComment(comment, test_users[0]));
				}
				frag.appendChild(container);
			}
			document.body.appendChild(frag);
		}
		function createComment(comment, author) {
			// JSONified HTML, because why not
			var structure = {tag: "div", attrs: {className: "comment"}, children: [
				{tag: "a", attrs: {className: "jump", name: comment.id}},
				{tag: "div", attrs: {className: "author"}, children: [
					{tag: "a", attrs: {className: "name", href: "/user/" + author.name}, children: [author.name]},
					{tag: "img", attrs: {className: "avatar", src: author.avatar}}
				]},
				{tag: "div", attrs: {className: "data"}, children: [
					{tag: "div", attrs: {className: "comment_arrow"}, children: [
						{tag: "div"}
					]},
					{tag: "div", attrs: {className: "metadata"}, children: [
						{tag: "a", attrs: {href: "#" + comment.id}, children: ["#" + comment.id]},
					]},
					{node: parser.render(comment.data), attrs: {className: "body"}}
				]}
			]};
			return createTree(structure);
		}
		function createTree(node) {
			var tag;
			if(node.tag) {
				tag = document.createElement(node.tag);
			}else if(node.node) {
				// this method of adding existing nodes allows us to add extra attrs
				tag = node.node;
			}
			for(var attr in node.attrs) {
				tag[attr] = node.attrs[attr];
			}
			if(node.children) {
				for(var i = 0; i < node.children.length; i++) {
					if(typeof node.children[i] == "string") {
						tag.appendChild(document.createTextNode(node.children[i]));
					}else{
						tag.appendChild(createTree(node.children[i]));
					}
				}
			}
			return tag;
		}
	</script>
</head>
<body onload="init()">
</body>
</html>

