<html>
<head>
	<style type="text/css">
		body {
			font-family: Helvetica, Arial;
			font-size: 16px;
		}
		div.comment {
			position: relative;
			padding: 10px;
			border-style: solid;
			border-bottom-style: dashed;
			border-width: 1px;
			border-top-width: 0px;
			border-color: gray;
			overflow: hidden;
			background-color: white;
		}
		div.comment:first-child {
			border-top-width: 1px;
		}
		div.comment:last-child {
			border-bottom-style: solid;
		}
		div.comment:nth-child(2n+1) {
			background-color: #F0F0F0;
		}
		div.selected {
			box-shadow: 0 0 30px rgba(0, 0, 255, 0.3);
		}
		div.data {
			position: relative;
			margin-left: 200px;
			border-radius: 3px;
			border-style: solid;
			border-color: gray;
			border-width: 1px;
			padding: 10px;
			background-color: white;
			font-size: 0.8em;
		}
		div.author {
			float: left;
			width: 180px;
			text-align: center;
		}
		div.name {
			display: inline-block;
			border-radius: 3px;
			background-color: #88a927;
			text-align: center;
			padding: 8px;
			text-shadow: -1px -1px rgba(0, 0, 0, 0.2);
			box-shadow: 0px 1px 0px rgba(255, 255, 255, 0.2) inset;
			border: 1px solid rgba(0, 0, 0, 0.2);
		}
		div.name a {
			color: #fff;
			text-decoration: none;
		}
		img.avatar {
			height: 128px;
			width: 128px;
			margin-top: 15px;
			border: solid 1px rgba(0, 0, 0, 0.2);
		}
		div.data div.data {
			margin: 0px;
			font-size: 1em;
		}
		div.data div.author {
			display: none;
		}
		div.comment_arrow {
			border-bottom: 11px solid transparent;
			border-right: 11px solid gray;
			border-top: 11px solid transparent;
			position: absolute;
			top: 10px;
			left: -11px;
		}
		div.comment_arrow div {
			border-bottom: 11px solid transparent;
			border-right: 11px solid white;
			border-top: 11px solid transparent;
			position: absolute;
			top: -11px;
			left: 1px;
		}
		div.metadata {
			border-bottom: 1px solid gray;
			font-size: 0.7em;
			margin-bottom: 10px;
			padding-bottom: 5px;
		}
		a.jump {
			position: absolute;
			top: -2px;
		}
		a.edit_button {
			border-radius: 2px;
			border-width: 1px;
			border-style: solid;
			padding-left: 3px;
			padding-right: 3px;
			background-color: #F0F0F0;
			float: right;
		}
	</style>
	<script type="text/javascript">
		var test_users = [
			{
				id: 0,
				name: "Nadnerb",
				avatar: "http://www.fimfiction-static.net/images/avatars/91255_128.jpg?1361969153"
			}
		];
		var test_comments = [
			{
				id: 0,
				author: 0,
				data: "This is some text >>3 and a quote."
			},
			{
				id: 1,
				author: 0,
				data: "This is some text"
			},
			{
				id: 2,
				author: 0,
				data: "This is some text"
			},
			{
				id: 3,
				author: 0,
				data: "This is some text"
			},
			{
				id: 4,
				author: 0,
				data: "This is some text"
			}
		];
	</script>
	<script type="text/javascript" src="bbcode.js"></script>
	<script type="text/javascript">
		var parser = new bbcode();
		function init() {
			writeComments();
			document.addEventListener("click", handleClick);
			window.onhashchange = highlightSelected;
			highlightSelected();
		}
		function handleClick(event) {
			// the most hilarious hack I ever did, literally copies elements from the page into the space where the quote goes
			if(event.target.classList.contains("quote_link")) {
				if(event.target.nextSibling.nodeName == "DIV") {
					event.target.parentNode.removeChild(event.target.nextSibling);
				}else{
					var elem = document.getElementsByName(event.target.hash.substring(1));
					if(elem.length) {
						var quote_container = document.createElement("div");
						quote_container.appendChild(elem[0].parentNode.cloneNode(true));
						event.target.parentNode.insertBefore(quote_container, event.target.nextSibling);
					}
				}
				event.preventDefault();
			}
		}
		function highlightSelected() {
			var elem = document.getElementsByClassName("selected");
			for(var i = 0; i < elem.length; i++) {
				elem[i].classList.remove("selected");
			}
			var jump = document.getElementsByName(window.location.hash.substring(1));
			for(var i = 0; i < jump.length; i++) {
				jump[i].parentNode.classList.add("selected");
			}
		}
		function writeComments() {
			for(var i = 0; i < test_comments.length; i++) {
				document.body.appendChild(createComment(test_comments[i], test_users[test_comments[i].author]));
			}
		}
		function createComment(comment, author) {
			// Generates a comment element
			var commentDiv = document.createElement("div");
			commentDiv.className = "comment";
			var jump = document.createElement("a");
			jump.className = "jump";
			jump.name = comment.id;
			commentDiv.appendChild(jump);
			var authorDiv = document.createElement("div");
			authorDiv.className = "author";
			var nameDiv = document.createElement("div");
			nameDiv.className = "name";
			var nameLink = document.createElement("a");
			nameLink.href = "user/" + author.name;
			nameLink.appendChild(document.createTextNode(author.name));
			nameDiv.appendChild(nameLink);
			authorDiv.appendChild(nameDiv);
			var avatar = document.createElement("img");
			avatar.className = "avatar";
			avatar.src = author.avatar;
			authorDiv.appendChild(avatar);
			commentDiv.appendChild(authorDiv);
			var data = document.createElement("div");
			data.className = "data";
			var arrow = document.createElement("div");
			arrow.className = "comment_arrow";
			arrow.appendChild(document.createElement("div"));
			data.appendChild(arrow);
			var meta = document.createElement("div");
			meta.className = "metadata";
			var permalink = document.createElement("a");
			permalink.href = "#" + comment.id;
			permalink.appendChild(document.createTextNode("#" + comment.id));
			meta.appendChild(permalink);
			var editLink = document.createElement("a");
			editLink.className = "edit_button";
			editLink.appendChild(document.createTextNode("Edit"));
			meta.appendChild(editLink);
			data.appendChild(meta);
			var body = parser.render(comment.data);
			body.className = "body";
			data.appendChild(body);
			commentDiv.appendChild(data);
			return commentDiv;
		}
	</script>
</head>
<body onload="init()">
</body>
</html>

